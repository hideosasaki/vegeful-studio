/**
 * Twitter module extending update_with_media
 * forked form http://taiyoh.hatenablog.com/entry/2012/09/19/110555
 * @author veeplant http://twilog.org/veeplant
 */
var util = require('util');
var Parent = require('twitter');
var request = require('request');
var fs = require('fs');

function Twitter() {
    Parent.apply(this, arguments);
}
util.inherits(Twitter, Parent);
module.exports = Twitter;

Twitter.prototype.updateStatus = function(text, params, callback) {
    var mediaKey = 'media[]';
    if (params[mediaKey] === undefined) {
        return Parent.prototype.updateStatus.apply(this, arguments);
    }
    if (typeof params === 'function') {
        callback = params;
        params = {};
    }
    var url = this.options.rest_base + '/statuses/update_with_media.json';
    var orderedParameters = this.oauth._prepareParameters(
        this.options.access_token_key,
        this.options.access_token_secret,
        'POST',
        url
    );
    var r = request.post(url, callback);
    r.setHeaders({authorization: this.oauth._buildAuthorizationHeaders(orderedParameters)});
    var form = r.form();
    form.append('status', text);
    for (var key in params) {
        if (key == mediaKey && typeof params[key] == 'string') {
            form.append(key, fs.createReadStream(params[key]));
        } else {
            form.append(key, params[key]);
        }
    }
    return this;
};
